<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>

    <!-- VectorGrid -->
    <script src="https://unpkg.com/leaflet.vectorgrid@latest/dist/Leaflet.VectorGrid.bundled.js"></script>

    <!-- Leaflet.pip -->
    <script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>

    <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">
    <link rel="manifest" href="./site.webmanifest">

    <link rel="stylesheet" href="./css/styles.css">

    <title>Geologic Map of Arizona</title>

</head>

<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-red">

        <a class="navbar-brand" href="http://www.arizona.edu" title="The University of Arizona">
            <img alt="The University of Arizona" height="16" src="./img/ua.svg" />
        </a>

        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link" title="Arizona Geological Survey" href="https://azgs.arizona.edu/">Arizona
                        Geological Survey</a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container-fluid p-0">
        <div class="alert alert-warning text-center">
            <strong>Note:</strong> This is a personal dev site for a master's project, and not a UArizona Domain.
        </div>
    </div>

    <div class="container">

        <div class="d-none d-sm-block p-2">
            <a href="http://www.azgs.arizona.edu">
                <img alt="Arizona Geological Survey" title="Arizona Geological Survey" width="375"
                    src="./img/azgs.png" />
            </a>
        </div>

        <div id='map'></div>

        <div id="mupModal" class="modal" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Modal title</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p>lorem ipsum lorem ipsum</p>
                    </div>
                    <!-- <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div> -->
                </div>
            </div>
        </div>

        <div id='legend'>
            <div class="alert alert-primary mt-5" role="alert">
                Still working on the static legend..
            </div>
            <!-- <div class="row">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h3 class="card-img-top" data-mapunit=""></h3>
                            <h5 class="card-title"></h5>
                            <p class="card-text"></p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h3 class="card-img-top" data-mapunit=""></h3>
                            <h5 class="card-title"></h5>
                            <p class="card-text"></p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h3 class="card-img-top" data-mapunit=""></h3>
                            <h5 class="card-title"></h5>
                            <p class="card-text"></p>
                        </div>
                    </div>
                </div>
            </div> -->

            <div class="row">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h3 class="card-img-top" data-mapunit="Q">Q</h3>
                            <h5 class="card-title">Quaternary Surficial deposits, undivided (0-2 Ma)</h5>
                            <p class="card-text">Unconsolidated to strongly consolidated alluvial and eolian deposits.
                                This unit includes: coarse, poorly sorted alluvial fan and terrace deposits on middle
                                and upper piedmonts and along large drainages; sand, silt and clay on alluvial plains
                                and playas; and wind-blown sand deposits.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h3 class="card-img-top" data-mapunit="QTb">QTb</h3>
                            <h5 class="card-title">Holocene to Middle Pliocene Basaltic Rocks (0-4 Ma)</h5>
                            <p class="card-text">Mostly dark-colored basaltic lava and cinders young enough that some
                                original volcanic landforms are still apparent. Includes a small amount of andesite,
                                dacite, and rhyolite. Rocks of this map unit are largely restricted to six areas widely
                                distributed in Arizona: San Francisco and Uinkaret volcanic fields in northern Arizona
                                (0-4 Ma); Springerville (0-4 Ma) and San Carlos (0-2 Ma) volcanic fields in east-central
                                Arizona; and San Bernardino (0-1 Ma) and Sentinel (1-4 Ma) volcanic fields in southern
                                Arizona. Rocks of this unit are also present in the extreme southwestern part of Arizona
                                where they were erupted at the edge of the Pinacate volcanic field (0-2 Ma) in
                                northwestern Sonora.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h3 class="card-img-top" data-mapunit="QTv">QTv</h3>
                            <h5 class="card-title">Holocene to Middle Pliocene Volcanic Rocks (0-4 Ma)</h5>
                            <p class="card-text">Rhyolite to andesite deposited as a sequence of lava flows and
                                associated rocks; generally light to medium gray, tan, or reddish brown. These rocks are
                                part of the San Francisco volcanic field.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h3 class="card-img-top" data-mapunit="Qr">Qr</h3>
                            <h5 class="card-title">Holocene River Alluvium (0-10 ka)</h5>
                            <p class="card-text">Unconsolidated to weakly consolidated sand and gravel in river channels
                                and sand, silt, and clay on floodplains. Also includes young terrace deposits fringing
                                floodplains.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h3 class="card-img-top" data-mapunit="Qy">Qy</h3>
                            <h5 class="card-title">Holocene Surficial Deposits (0-10 ka)</h5>
                            <p class="card-text">Unconsolidated deposits associated with modern fluvial systems. This
                                unit consists primarily of fine-grained, well-sorted sediment on alluvial plains, but
                                also includes gravelly channel, terrace, and alluvial fan deposits on middle and upper
                                piedmonts.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h3 class="card-img-top" data-mapunit="Qm">Qm</h3>
                            <h5 class="card-title">Late And Middle Pleistocene Surficial Deposits (10-750 ka)</h5>
                            <p class="card-text">Unconsolidated to weakly consolidated alluvial fan, terrace, and
                                basin-floor deposits with moderate to strong soil development. Fan and terrace deposits
                                are primarily poorly sorted, moderately bedded gravel and sand, and basin-floor deposits
                                are primarily sand, silt, and clay.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer mt-5">
        <div class="container">
            <div class="text-center text-muted p-3">
                <div class="p-2">520.621.2352 | 1955 East 6th Street, P.O. Box 210184, Tucson, AZ 85721</div>
                <div class="p-2">The maps, reports, and other information and content on this website are provided
                    as
                    a
                    public service for informational purposes only. Accuracy is not guaranteed, and the information
                    contained or linked on this website should not be relied on except as general information. The
                    University makes no
                    warranties or representations of any kind, and specifically disclaims all warranties including
                    the
                    warranty of merchantability and fitness for a particular purpose. Users are responsible for
                    verification
                    of all
                    facts and information to their own satisfaction.</div>
                <div class="p-2">Â© 2022 The Arizona Board of Regents on behalf of <a href="http://www.arizona.edu"
                        style="color: #333; font-weight: 700; text-decoration: underline;" target="_blank">The
                        University of Arizona</a>.</div>
            </div>
        </div>
    </div>

    <script src="./js/dmu.js"></script>
    <script>

        var map = L.map('map', {
            center: [34.16, -111.62],
            maxBounds: L.latLngBounds([[29.96818929679422, -126.13671875], [38.34395908944491, -97.226318359375]]),
            maxZoom: 13,
            minZoom: 6,
            zoom: 7,
        });

        var MapUnitPolysStyles = {};

        $.getJSON("https://vectortileservices1.arcgis.com/Ezk9fcjSUkeadg6u/arcgis/rest/services/MapUnitPolys_VectorTileFeature/VectorTileServer/resources/styles/root.json?f=pjson", function success(data) {

            $.each(data.layers, function (key, val) {

                var id = val.id.replace(val["source-layer"] + "/", "");

                if (id !== "<all other values>") {

                    var mapUnit = dmu.find((o) => { return o["MapUnit"] === id })

                    var rgb = "rgb(" + mapUnit.AreaFillRGB.replaceAll(";", ",") + ")";

                    MapUnitPolysStyles[key] = {
                        "id": id,
                        "source": val.source,
                        "source-layer": val["source-layer"],
                        "fill-color": val.paint["fill-color"],
                        "fill-outline-color": val.paint["fill-outline-color"],

                        "name": mapUnit.Name,
                        "description": mapUnit.Description,
                        "rgb": rgb,
                        "age": mapUnit.Age,
                    }
                }

            });

            var USGS_USTopo = L.tileLayer('https://basemap.nationalmap.gov/arcgis/rest/services/USGSTopo/MapServer/tile/{z}/{y}/{x}', {
                attribution: '<a href="https://usgs.gov/">U.S. Geological Survey</a>'
            }).addTo(map);

            var USGS_USImageryTopo = L.tileLayer('https://basemap.nationalmap.gov/arcgis/rest/services/USGSImageryTopo/MapServer/tile/{z}/{y}/{x}', {
                attribution: '<a href="https://usgs.gov/">U.S. Geological Survey</a>'
            });

            var OpenStreetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            });

            // Map Unit Poly vectorGrid layer
            var mups = L.vectorGrid.protobuf("https://vectortileservices1.arcgis.com/Ezk9fcjSUkeadg6u/arcgis/rest/services/MapUnitPolys_VectorTileFeature/VectorTileServer/tile/{z}/{y}/{x}.pbf", {
                attribution: '<a href="https://www.azgs.arizona.edu/">Arizona Geological Survey</a>',
                vectorTileLayerStyles: {
                    "Map Unit Polys": function (properties, zoom, geometryDimension) {

                        var rgb = MapUnitPolysStyles[properties._symbol]["rgb"];
                        var outlineColor = MapUnitPolysStyles[properties._symbol]["fill-outline-color"];

                        return ({
                            weight: 1,
                            fillColor: rgb,
                            color: outlineColor,
                            fillOpacity: .5,
                            fill: true
                        });
                    }
                },
                interactive: true
            }).addTo(map);;

            // Basemap layer group
            var basemaps = {
                "USGS Topo": USGS_USTopo,
                "USGS Imagery Topo": USGS_USImageryTopo,
                "Open Street Map": OpenStreetMap
            }

            // Add uncollapsed layer controller to the map.
            var layerControl = L.control.layers(basemaps, { "Geologic Units": mups }, { collapsed: false }).addTo(map);

            mups.on('click', function (e) {
                // console.log(MapUnitPolysStyles[e.sourceTarget.properties._symbol])

                // leaflet popup
                // var info =  `<div class='border border-dark font-weight-bold p-3' style='background-color:${MapUnitPolysStyles[e.sourceTarget.properties._symbol]['rgb']}'>${MapUnitPolysStyles[e.sourceTarget.properties._symbol]["name"]}</div>`
                // info += `<p>${MapUnitPolysStyles[e.sourceTarget.properties._symbol]["description"]}</p>`
                // var pop = L.popup().setLatLng(e.latlng).setContent(info).openOn(map);

                var rgb = MapUnitPolysStyles[e.sourceTarget.properties._symbol]['rgb'];
                var name = MapUnitPolysStyles[e.sourceTarget.properties._symbol]["name"];
                var description = MapUnitPolysStyles[e.sourceTarget.properties._symbol]["description"];

                // BOOTSTRAP MODAL 
                var body = `<p>${description}</p>`
                $("#mupModal .modal-title").text(name);
                $("#mupModal .modal-body").html(body);
                $("#mupModal .modal-header").css("background-color", rgb);
                $('#mupModal').modal('show');
            });

            // MUPs info box
            var info = L.control();

            // Setup html and update function for the info box
            info.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'mupInfo invisible');
                this.update();
                return this._div;
            };

            // Update html function for Mups info box
            info.update = function (props) {
                this._div.innerHTML = (props ? `<div>${props.name}</div>` : '');
            };

            info.addTo(map);

            // Update MUPs info box on mouseover
            mups.on('mouseover', function (e) {
                $('.mupInfo').removeClass("invisible")
                info.update(MapUnitPolysStyles[e.sourceTarget.properties._symbol]);
            });

            // Hide the MUPs info box on mouse out of the mup layer
            mups.on('mouseout', function () { $('.mupInfo').addClass("invisible") });

            L.control.scale().addTo(map);

            // AZGS Datasets
            $.getJSON("https://data.azgs.arizona.edu/api/v1/metadata?collection_group=ADGM&format=geojson&latest=true&limit=200", function success(data) {

                function onAzgsClick(e) {
                    var features = leafletPip.pointInLayer(e.latlng, azgsMaps);
                    var bodyHtml = "<div>";

                    features.forEach((polygon) => {
                        console.log(polygon.feature.properties);
                        bodyHtml += `<b>${polygon.feature.properties.title} (${polygon.feature.properties.year})</b><br/>`;
                        bodyHtml += '</p >';
                    });

                    bodyHtml += "TODO: format & links</div>";

                    $("#mupModal .modal-title").text(`${features.length} AZGS Datasets`);
                    $("#mupModal .modal-body").html(bodyHtml);
                    $("#mupModal .modal-header").css("background-color", "#D3D3D3");
                    $('#mupModal').modal('show');

                }

                var azgsMaps = L.geoJSON(data, {
                    style: function (feature) {
                        // Make the Map of AZ transparent so it isn't annoying
                        if (feature.properties.identifiers.perm_id === 'ADGM-1552430548157-680') {
                            return { fillOpacity: 0, opacity: 0 };
                        } else {
                            // Random color fill
                            return { color: "#1E5288", fillColor: "#" + ((1 << 24) * Math.random() | 0).toString(16) };
                        }
                    }
                });

                azgsMaps.on('click', onAzgsClick);

                layerControl.addOverlay(azgsMaps, "AZGS Datasets");

            });

        });

    </script>
</body>

</html>