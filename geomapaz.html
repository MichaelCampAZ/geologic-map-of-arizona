<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css"
        integrity="sha384-zCbKRCUGaJDkqS1kPbPd7TveP5iyJE0EjAuZQTgFLD2ylzuqKfdKlfG/eSrtxUkn" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
        integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
        integrity="sha384-VHvPCCyXqtD5DqJeNxl2dtTyhF78xXNXdkwX1CZeRusQfRKp+tA7hAShOK/B/fQ2"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-fQybjgWLrvvRgtW6bFlB7jaZrFsaBXjsOMm/tB9LTS58ONXgqbR9W8oWht/amnpF"
        crossorigin="anonymous"></script>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>

    <!-- VectorGrid -->
    <script src="https://unpkg.com/leaflet.vectorgrid@latest/dist/Leaflet.VectorGrid.bundled.js"></script>

    <!-- Leaflet.pip -->
    <script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>

    <!-- Datatables -->
    <link rel="stylesheet" type="text/css"
        href="https://cdn.datatables.net/v/bs4/dt-1.11.5/r-2.2.9/datatables.min.css" />
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs4/dt-1.11.5/r-2.2.9/datatables.min.js"></script>

    <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">
    <link rel="manifest" href="./site.webmanifest">

    <link rel="stylesheet" href="./css/styles.css">

    <title>Geologic Map of Arizona</title>

</head>

<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-azred">

        <a class="navbar-brand" href="http://www.arizona.edu" title="The University of Arizona">
            <img alt="The University of Arizona" height="16" src="./img/ua.svg" />
        </a>

        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link" title="Arizona Geological Survey" href="https://azgs.arizona.edu/">Arizona
                        Geological Survey</a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container-fluid p-0">
        <div class="alert alert-warning text-center">
            <strong>Note:</strong> This is a personal dev site for a master's project, and not a UArizona Domain.
        </div>
    </div>

    <div class="container">

        <div class="d-none d-sm-block p-2">
            <a href="http://www.azgs.arizona.edu">
                <img alt="Arizona Geological Survey" title="Arizona Geological Survey" width="375"
                    src="./img/azgs.png" />
            </a>
        </div>

        <div id='map'></div>

        <div id="Modal" class="modal" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Modal title</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <h6 class="modal-age text-dark text-right pb-1 pr-1"></h6>
                    <div class="modal-body">
                    </div>
                </div>
            </div>
        </div>

        <div class="accordion mt-2 mb-1" id="legends">
            <div>
                <div class="mb-2" id="headingOne">
                    <button class="btn btn-azblue text-white btn-lg btn-block collapsed" type="button"
                        data-toggle="collapse" data-target="#collapseOne" aria-expanded="true"
                        aria-controls="collapseOne">
                        GEOLOGIC UNITS
                    </button>
                </div>
                <div id="collapseOne" class="collapse" aria-labelledby="headingOne" data-parent="#legends">
                    <div>

                        <div>
                            <table id="mupsTable" class="table" style="width:100%">
                                <thead>
                                    <tr>
                                        <th class="dtr-control"></th>
                                        <th>Name</th>
                                        <th class="min-desktop">Age</th>
                                        <th class="min-desktop">Description</th>
                                    </tr>
                                </thead>
                                <tbody id="mupsTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-2">
                <div class="mb-1" id="headingTwo">
                    <button class="btn btn-azblue text-white btn-lg btn-block collapsed" type="button"
                        data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false"
                        aria-controls="collapseTwo">
                        FAULTS
                    </button>
                </div>
                <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#legends">

                    <div class="row text-center">
                        <div class="col-lg-3 col-md-6 p-1">
                            <div class="card">
                                <div class="card-body">
                                    <img src="./img/azgs100.png">
                                    <h5 class="card-title" data-key="2.1.1">Fault</h5>
                                    <p class="card-text">Fault (generic; vertical, subvertical, or high-angle; or
                                        unknown or unspecified orientation or sense of slip) —Identity and existence
                                        certain, location accurate</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 p-1">
                            <div class="card">
                                <div class="card-body">
                                    <img src="./img/azgs100.png">
                                    <h5 class="card-title" data-key="2.10.1">Detachment fault</h5>
                                    <p class="card-text">Detachment fault (sense of slip unspecified) (1st
                                        option)—Identity and existence certain, location accurate. Hachures on upper
                                        plate Detachment fault (sense of slip unspecified)</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 p-1">
                            <div class="card">
                                <div class="card-body">
                                    <img src="./img/azgs100.png">
                                    <h5 class="card-title" data-key="2.8.1">Thrust fault</h5>
                                    <p class="card-text">Thrust fault (1st option)—Identity and existence certain,
                                        location accurate. Sawteeth on upper (tectonically higher) plate</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 p-1">
                            <div class="card">
                                <div class="card-body">
                                    <img src="./img/azgs100.png">
                                    <h5 class="card-title" data-key="2.10.33">Listric fault</h5>
                                    <p class="card-text">Listric fault at head of detachment fault (sense of slip
                                        unspecified)—Identity and existence certain, location accurate. Ticks on
                                        upper plate
                                    </p>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <div class="mt-2">
                <div class="mb-2" id="headingThree">
                    <button class="btn btn-azblue text-white btn-lg btn-block collapsed" type="button"
                        data-toggle="collapse" data-target="#collapseThree" aria-expanded="false"
                        aria-controls="collapseThree">
                        GEOLOGIC MAPS
                    </button>
                </div>
                <div id="collapseThree" class="collapse" aria-labelledby="headingThree" data-parent="#legends">
                    <div>
                        <table id="azgsMapTable" class="table" style="width:100%">
                            <thead>
                                <tr>
                                    <th class="dtr-control"></th>
                                    <th class="min-tablet-p">Year</th>
                                    <th class="" data-priority="1">Title</th>
                                    <th class="none">Author</th>
                                    <th class="none">Abstract</th>
                                </tr>
                            </thead>
                            <tbody id="azgsMapTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer mt-5">
        <div class="container">
            <div class="text-center text-muted p-3">
                <div class="p-2">520.621.2352 | 1955 East 6th Street, P.O. Box 210184, Tucson, AZ 85721</div>
                <div class="p-2">The maps, reports, and other information and content on this website are provided
                    as a
                    public service for informational purposes only. Accuracy is not guaranteed, and the information
                    contained or linked on this website should not be relied on except as general information. The
                    University makes no
                    warranties or representations of any kind, and specifically disclaims all warranties including
                    the
                    warranty of merchantability and fitness for a particular purpose. Users are responsible for
                    verification
                    of all
                    facts and information to their own satisfaction.</div>
                <div class="p-2">© 2022 The Arizona Board of Regents on behalf of <a href="http://www.arizona.edu"
                        style="color: #333; font-weight: 700; text-decoration: underline;" target="_blank">The
                        University of Arizona</a>.</div>
            </div>
        </div>
    </div>

    <script src="./js/MupJson.js"></script>
    <script>

        $(function () {


            // Set zoom level at 6 for mobile screens
            var zoomLevel = L.Browser.mobile ? 6 : 7;

            // Map init
            var map = L.map('map', {
                center: [34.16, -111.62],
                maxBounds: L.latLngBounds([[29.96818929679422, -126.13671875], [38.34395908944491, -97.226318359375]]),
                maxZoom: 13,
                minZoom: 6,
                zoom: zoomLevel,
            });

            // USGS_USTopo Basemap
            var USGS_USTopo = L.tileLayer('https://basemap.nationalmap.gov/arcgis/rest/services/USGSTopo/MapServer/tile/{z}/{y}/{x}', {
                attribution: '<a href="https://usgs.gov/">U.S. Geological Survey</a>'
            }).addTo(map);

            // USGS_USImageryTopo Basemap
            var USGS_USImageryTopo = L.tileLayer('https://basemap.nationalmap.gov/arcgis/rest/services/USGSImageryTopo/MapServer/tile/{z}/{y}/{x}', {
                attribution: '<a href="https://usgs.gov/">U.S. Geological Survey</a>'
            });

            // OpenStreetMap Basemap
            var OpenStreetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            });

            // Basemap layer group
            var basemaps = {
                "USGS Topo": USGS_USTopo,
                "USGS Imagery Topo": USGS_USImageryTopo,
                "Open Street Map": OpenStreetMap
            }

            // Add uncollapsed layer controller to the map.
            var layerControl = L.control.layers(basemaps, {}).addTo(map);

            // Add scale bar
            L.control.scale().addTo(map);

            // Map Unit Poly vectorGrid layer
            var mups = L.vectorGrid.protobuf("https://vectortileservices1.arcgis.com/Ezk9fcjSUkeadg6u/arcgis/rest/services/MapUnitPolysGeoMapAz/VectorTileServer/tile/{z}/{y}/{x}", {
                attribution: '<a href="https://www.azgs.arizona.edu/">AZGS</a>',
                vectorTileLayerStyles: {
                    "MapUnitPolys": function (properties, zoom, geometryDimension) {

                        // Get the symbol value of the feature
                        var symbol = properties._symbol;

                        // Get the map unit with that symbol
                        var MapUnit = MupsJson[symbol];

                        return ({
                            weight: 1,
                            fillColor: MapUnit.rgb,
                            color: '#6E6E6E',
                            fillOpacity: .5,
                            fill: true
                        });
                    }
                },
                interactive: true
            }).addTo(map);

            layerControl.addOverlay(mups, "Geologic Units");

            mups.on('click', function (e) {
                // Get the symbol from the event
                var symbol = e.sourceTarget.properties._symbol;

                // Get the map unit from the symbol
                var MapUnit = MupsJson[symbol]

                var rgb = MapUnit.rgb;
                var fullname = MapUnit.fullname;
                var description = MapUnit.description;
                var age = MapUnit.age;

                // BOOTSTRAP MODAL 
                var body = `<p>${description}</p>`
                $("#Modal .modal-title").text(fullname);
                $("#Modal .modal-age").text(age);
                $("#Modal .modal-body").html(body);
                $("#Modal .modal-header").css("background-color", rgb);
                $('#Modal').modal('show');
            });

            // Map info box
            var info = L.control();

            // Setup html and update function for the info box
            info.onAdd = function (map) {
                this._div = L.DomUtil.create('div', 'mapInfoBox invisible');
                this.update();
                return this._div;
            };

            // Update html function for map info box
            info.update = function (update) {
                $('.mapInfoBox').removeClass("invisible");
                this._div.innerHTML = (update ? `<div>${update}</div>` : '');
            };

            info.addTo(map);

            // Update map info box on MUPS mouseover
            mups.on('mouseover', function (e) {

                var symbol = e.sourceTarget.properties._symbol;

                var MapUnit = MupsJson[symbol]

                info.update(MapUnit.fullname);
            });

            // Hide the map info box on mouse out of the map
            mups.on('mouseout', function () { $('.mapInfoBox').addClass("invisible") });

            var CFTile = L.tileLayer('https://tiles.arcgis.com/tiles/Ezk9fcjSUkeadg6u/arcgis/rest/services/SymbolizedFaultsGeoMapAz/MapServer/tile/{z}/{y}/{x}', {
                attribution: '<a href="https://www.azgs.arizona.edu/">AZGS</a>',
            }).addTo(map);

            layerControl.addOverlay(CFTile, "Faults");

            // AZGS Datasets
            $.getJSON("https://data.azgs.arizona.edu/api/v1/metadata?collection_group=ADGM&format=geojson&latest=true&limit=500", function success(data) {

                function onAzgsClick(e) {
                    var features = leafletPip.pointInLayer(e.latlng, azgsMaps);

                    if (features.length === 0 ){
                        return;
                    }

                    var bodyHtml = "<div>";

                    features.forEach((polygon) => {
                        console.log(polygon.feature.properties);
                        bodyHtml += `<p><a class="text-decoration-none" target="_blank" href="${polygon.feature.properties.links[0].url}">${polygon.feature.properties.title}</a></p>`;
                    });

                    bodyHtml += '</div>';

                    var mapPlural = features.length === 1 ? "Map" : "Maps";

                    $("#Modal .modal-title").text(`Geologic ${mapPlural}`);
                    $("#Modal .modal-age").text("");
                    $("#Modal .modal-body").html(bodyHtml);
                    $("#Modal .modal-header").css("background-color", "#D3D3D3");
                    $('#Modal').modal('show');

                }

                var azgsMaps = L.geoJSON(data, {
                    attribution: '<a href="https://www.azgs.arizona.edu/">AZGS</a>',
                    filter: function (feature) {
                        // Remove the big datasets
                        if (feature.properties.identifiers.perm_id === 'ADGM-1552430548157-680') {
                            return false;
                        }

                        return true;
                    },
                    style: function (feature) {
                        return { color: "#1E5288", fillColor: "#" + ((1 << 24) * Math.random() | 0).toString(16) };
                    }
                });

                azgsMaps.on('click', onAzgsClick);

                layerControl.addOverlay(azgsMaps, "Geologic Maps");

                $.each(data.features, function (index, value) {

                    if (value.properties.links[0]) {
                        var title = value.properties.title;
                        var year = value.properties.year;
                        var abstract = value.properties.abstract;
                        var url = value.properties.links[0].url;

                        var authors = "";
                        $.each(value.properties.authors, function (index, value) {
                            if (value.person) {
                                authors += value.person + "<br />";
                            }
                        });

                        $("#azgsMapTableBody").append(`<tr><td></td><td>${year}</td><td><a href="${url}" target="_blank">${title}</a><td>${authors}</td></td><td>${abstract}</td></tr>`);
                    }

                });

                var azgsTable = $('#azgsMapTable').DataTable({
                    autoWidth: false,
                    columnDefs: [
                        { orderable: false, targets: 0 }
                    ],
                    order: [[1, 'desc']],
                    responsive: {
                        details: {
                            display: $.fn.dataTable.Responsive.display.modal({
                                header: function (row) {
                                    return 'Arizona Geological Survey Digital Geologic Map';
                                }
                            }),
                            renderer: $.fn.dataTable.Responsive.renderer.tableAll({
                                tableClass: 'table'
                            })
                        }
                    }
                });

            });

            // Build the MUP legend
            $.each(MupsJson, function (index, value) {
                var rgb = value.rgb;
                var age = value.age;
                var fullname = value.fullname;
                var description = value.description;

                $("#mupsTableBody").append(`<tr><td></td><td style="font-size:1.05rem;background-color:${rgb};" >${fullname}</td><td>${age}</td><td>${description}</td></tr>`);

            });

            var mupsTable = $('#mupsTable').DataTable({
                autoWidth: false,
                responsive: true,
                columnDefs: [
                    { orderable: false, targets: 0 }
                ],
                order: [[1, 'asc']],
            });

        });

    </script>
</body>

</html>